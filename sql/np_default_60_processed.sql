SELECT l_returnflag, l_linestatus, avg(running_charge) AS avg_running_charge, count(*) AS cnt FROM (SELECT l_returnflag, l_linestatus, l_orderkey, sum(l_extendedprice * (1 - l_discount)) OVER (PARTITION BY l_orderkey ORDER BY l_linenumber ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS running_charge FROM lineitem WHERE l_shipdate <= (toDate('1998-12-01') - toIntervalDay('90'))) AS t GROUP BY l_returnflag, l_linestatus ORDER BY l_returnflag ASC, l_linestatus ASC;

SELECT l_returnflag, l_linestatus, sum(l_quantity) / 64 AS sum_qty, sum(l_extendedprice) / 64 AS sum_base_price, sum(l_extendedprice * (1 - l_discount)) / 64 AS sum_disc_price, sum((l_extendedprice * (1 - l_discount)) * (1 + l_tax)) / 64 AS sum_charge, avg(l_quantity) AS avg_qty, avg(l_extendedprice) AS avg_price, avg(l_discount) AS avg_disc, count(*) / 64 AS count_order FROM (SELECT l_returnflag, l_linestatus, l_quantity, l_extendedprice, l_discount, l_tax FROM lineitem WHERE l_shipdate <= (toDate('1998-12-01') - toIntervalDay('90'))) AS l CROSS JOIN (SELECT number FROM system.numbers LIMIT 4) AS dup GROUP BY l_returnflag, l_linestatus ORDER BY l_returnflag ASC, l_linestatus ASC;

